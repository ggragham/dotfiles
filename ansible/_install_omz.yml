---
- name: Install zsh
  block:
    - name: Install zsh to Fedora
      dnf:
        name: zsh
        state: latest
        update_cache: true
        install_weak_deps: false
      when: ansible_distribution=='Fedora'
    - name: Install zsh to Debian
      apt:
        name: zsh
        state: latest
        update_cache: true
      when: ansible_distribution=='Debian'
- name: Set zsh
  user:
    name: '{{ user }}'
    shell: /bin/zsh
- name: Install and config Oh My ZSH
  block:
    - name: Run omz install script
      shell:
        cmd: >
          curl -o- https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh
          | bash
        creates: '{{ local_opt_path }}/oh-my-zsh/oh-my-zsh.sh'
      environment:
        ZSH: '{{ local_opt_path }}/oh-my-zsh'
        CHSH: 'no'
        RUNZSH: 'no'
    - name: Install OMZ plugins
      git:
        repo: https://github.com/zsh-users/{{ item }}.git
        dest: '{{ local_opt_path }}/oh-my-zsh/custom/plugins/{{ item }}'
        version: master
        update: true
      with_items: [zsh-syntax-highlighting, zsh-autosuggestions]
    - name: Config OMZ
      block:
        - name: Get distro_name name
          set_fact:
            distro_name: '{{ ansible_distribution | lower }}'
        - name: Create omz config directory
          file:
            path: '{{ omz_path }}'
            state: directory
            owner: '{{ user }}'
            mode: 0700
        - name: Make .zshrc symlink
          file:
            src: '{{ omz_path }}/.zshrc'
            dest: '{{ home_path }}/.zshrc'
            state: link
            force: true
            owner: '{{ user }}'
            mode: 0700
        - name: Make config symlinks
          file:
            src: '{{ omz_path }}/{{ item }}'
            dest: '{{ local_config_path }}/omz/{{ item }}'
            state: link
            force: true
            owner: '{{ user }}'
            mode: 0700
          with_items: [alias_zsh, '{{ distro_name }}_zsh']
  become_user: '{{ user }}'
